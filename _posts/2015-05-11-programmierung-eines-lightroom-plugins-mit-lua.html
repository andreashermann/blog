---
layout: post
title: Programmierung eines Lightroom Plugins mit Lua
---

<h4>Motivation</h4>In meinen letzten Ferien habe ich einige Time-Lapse-Videos erstellt.<br />Dazu habe ich meist <a href="http://boinx.com/istopmotion/mac/" target="_blank">iStopMotion</a> verwendet. Es wird zwar nicht ausdrücklich dafür beworben, doch es erfüllt den Zweck. Man kann Fotos importieren, die Bild-Rate wählen und das Resultat dann als Video rendern.<br />Es gibt zwar noch Alternativen wie <a href="http://lrtimelapse.com/" target="_blank">LRTimelapse</a>&nbsp;(99 EUR) die viele nette Features bringen, doch die Bedienung und der Workflow wirken etwas umständlich.<br />Wenn es nur darum geht eine erste Ansicht eines Video zu erstellen wäre es schön, wenn es einfacher wäre.<br /><br />Deshalb habe ich mich entschieden ein eigenes kleines Plugin namens "Video Renderer" für Adobe Photoshop Lightroom® zu schreiben.<br /><br />Meine <b>Anforderungen</b> sind vorerst ziemlich eingeschränkt:<br />- Rendern eines Filmes aus einer Sequenz von Fotos in Lightroom unter Mac OS X<br />- Codec: H264, Bild-Rate 30fps<br />- Bild-Grösse 1080p<br /><br />Das Resultat steht auf Github kostenlos zum <a href="https://github.com/andreashermann/VideoRenderer/releases" target="_blank">Download</a> zur Verfügung.<br />Das Binary und der Source-Code stehen können unter der MIT Lizenz genutzt werden.<br /><br /><h4>Vorgehen zur Entwicklung eines solchen Plugins.</h4><div><br /></div><b>1. Erkunden des SDKs</b><br /><br />Das&nbsp;<a href="http://www.adobe.com/devnet/photoshoplightroom.html" target="_blank">SDK</a>&nbsp;steht bei Adobe als Download (8MB) zur Verfügung.<br />Das API ist in Lua geschrieben. Dies bedeutet dass Plugins grundsätzlich auch in Lua programmiert werden müssen.<br />Natürlich kann man mit Lua externe Prozesse starten und dies ist auch möglich in Lightroom Plugins. Somit können beliebige externe Tools eingebunden werden.<br /><br />Das SDK wird begleitet von einem ausführlichem <a href="http://wwwimages.adobe.com/content/dam/Adobe/en/devnet/photoshoplightroom/pdfs/lr5/lightroom-sdk-guide.pdf" target="_blank">Programmers Guide</a> als PDF und einer HTML-Basierten API-Referenz. Für alle der verschiedenen Plugin-Typen gibt es ein ausführliches Beispiel mit komplettem Programm-Code.<br /><br />Grundsätzlich sind diese Features in Lightroom erweiterbar:<br /><br /><ul><li>Befehle im Menu "Library", "Help" und "Export"</li><li>Export- und Publish-Dienste</li><li>Metadaten-Felder</li><li>HTML Web-Engine für Fotogalerien</li></ul><br />Es gibt sowohl ein <a href="https://forums.adobe.com/community/labs/lightroomplugins/" target="_blank">Lightroom Users Forum</a> als auch ein <a href="https://forums.adobe.com/community/lightroom/lightroom_sdk/content?filterID=contentstatus[published]~objecttype~objecttype[thread]" target="_blank">Lightroom SDK&nbsp;Forum</a>. Auf der Website des SDK wird aber leider nur auf das User Forum verlinkt.<br />Der Typ "Export-Service" scheint für meine Zwecke zu passen.<br /><br class="Apple-interchange-newline" />Die Verwendung des Plugins stelle ich mir etwa so vor:<br /><ol><li>Fotos aus Lightroom-Katalog selektieren und exportieren.</li><li>Im Export-Dialog das Plugin "Video Renderer" wählen und die Render-Parameter wählen.</li><li>Button "Exportieren" anklicken und ein paar Sekunden warten.</li></ol><b>2. Plugin implementieren</b><br /><br />Eine einfache Möglichkeit um Bildsequenzen zu rendern, ist die Open-Source Software&nbsp;<a href="https://www.ffmpeg.org/" target="_blank">ffmpeg</a>.<br />Der Render-Befehl damit in Lua so aus:<br /><br /><span style="font-family: Courier New, Courier, monospace; font-size: x-small;">local ffmpegPath = LrPathUtils.child(_PLUGIN.path, "ffmpeg")</span><br /><span style="font-family: Courier New, Courier, monospace; font-size: x-small;">local outputPath = exportParams.LR_export_destinationPathPrefix</span><br /><span style="font-family: Courier New, Courier, monospace; font-size: x-small;">local outputFile = exportParams.filename</span><br /><span style="font-family: Courier New, Courier, monospace; font-size: x-small;">local command = string.format("\"%s\" -y -i %s/\%05d.jpg -c:v libx264 -r 30 -vf scale=-1:1080 -pix_fmt yuv420p \"%s/%s\"",&nbsp;</span><br /><span style="font-family: Courier New, Courier, monospace; font-size: x-small;"><span class="Apple-tab-span" style="white-space: pre;">  </span>ffmpegPath, outputPath, outputPath, outputFile)</span><br /><span style="font-family: Courier New, Courier, monospace; font-size: x-small;">result = LrTasks.execute(command)</span><br /><br /><b>LrPathUtils</b> und <b>LrTasks</b> sind Teil des Lightroom SDKs.<br /><br />Für das Rendern muss ich mit dem Plugin eine Version von ffmpeg mitliefern. Da ich momentan nur OS X unterstützen möchte, ist das relativ einfach. Ich besorge mir&nbsp;<a href="http://evermeet.cx/ffmpeg/" target="_blank">hier</a>&nbsp;ein statisches Binary für Mac OS X 64-bit Intel.<br /><br />Der Export-Dialog in Lightroom kann mit einigen Zeilen Lua definiert werden:<br /><br /><span style="font-family: Courier New, Courier, monospace; font-size: x-small;">exportServiceProvider.sectionsForBottomOfDialog = function ( f, propertyTable )</span><br /><span style="font-family: Courier New, Courier, monospace; font-size: x-small;"><span class="Apple-tab-span" style="white-space: pre;"> </span>local LrView = import 'LrView'</span><br /><span style="font-family: Courier New, Courier, monospace; font-size: x-small;"><span class="Apple-tab-span" style="white-space: pre;"> </span>local bind = LrView.bind</span><br /><span style="font-family: Courier New, Courier, monospace; font-size: x-small;"><span class="Apple-tab-span" style="white-space: pre;"> </span>local share = LrView.share</span><br /><span style="font-family: Courier New, Courier, monospace; font-size: x-small;"><span class="Apple-tab-span" style="white-space: pre;"> </span>local result = {</span><br /><span style="font-family: Courier New, Courier, monospace; font-size: x-small;"><span class="Apple-tab-span" style="white-space: pre;">  </span>{</span><br /><span style="font-family: Courier New, Courier, monospace; font-size: x-small;"><span class="Apple-tab-span" style="white-space: pre;">   </span>title = LOC "$$$/VideoRenderer/ExportDialog/VideoSettings=Render Settings",</span><br /><span style="font-family: Courier New, Courier, monospace; font-size: x-small;"><span class="Apple-tab-span" style="white-space: pre;">   </span>synopsis = bind { key = 'fullPath', object = propertyTable },</span><br /><span style="font-family: Courier New, Courier, monospace; font-size: x-small;"><span class="Apple-tab-span" style="white-space: pre;">   </span>f:row {</span><br /><span style="font-family: Courier New, Courier, monospace; font-size: x-small;"><span class="Apple-tab-span" style="white-space: pre;">    </span>f:static_text {</span><br /><span style="font-family: Courier New, Courier, monospace; font-size: x-small;"><span class="Apple-tab-span" style="white-space: pre;">     </span>title = LOC "$$$/VideoRenderer/ExportDialog/FileName=File Name:",</span><br /><span style="font-family: Courier New, Courier, monospace; font-size: x-small;"><span class="Apple-tab-span" style="white-space: pre;">     </span>alignment = 'right',</span><br /><span style="font-family: Courier New, Courier, monospace; font-size: x-small;"><span class="Apple-tab-span" style="white-space: pre;">     </span>width = share 'leftLabel',</span><br /><span style="font-family: Courier New, Courier, monospace; font-size: x-small;"><span class="Apple-tab-span" style="white-space: pre;">    </span>},</span><br /><span style="font-family: Courier New, Courier, monospace; font-size: x-small;"><span class="Apple-tab-span" style="white-space: pre;">    </span>f:edit_field {</span><br /><span style="font-family: Courier New, Courier, monospace; font-size: x-small;"><span class="Apple-tab-span" style="white-space: pre;">     </span>value = bind 'filename',</span><br /><span style="font-family: Courier New, Courier, monospace; font-size: x-small;"><span class="Apple-tab-span" style="white-space: pre;">     </span>truncation = 'middle',</span><br /><span style="font-family: Courier New, Courier, monospace; font-size: x-small;"><span class="Apple-tab-span" style="white-space: pre;">     </span>immediate = true,</span><br /><span style="font-family: Courier New, Courier, monospace; font-size: x-small;"><span class="Apple-tab-span" style="white-space: pre;">     </span>fill_horizontal = 1,</span><br /><span style="font-family: Courier New, Courier, monospace; font-size: x-small;"><span class="Apple-tab-span" style="white-space: pre;">    </span>},</span><br /><span style="font-family: Courier New, Courier, monospace; font-size: x-small;"><span class="Apple-tab-span" style="white-space: pre;">   </span>}</span><br /><span style="font-family: Courier New, Courier, monospace; font-size: x-small;"><span class="Apple-tab-span" style="white-space: pre;">  </span>}</span><br /><span style="font-family: Courier New, Courier, monospace; font-size: x-small;"><span class="Apple-tab-span" style="white-space: pre;"> </span>}</span><br /><span style="font-family: Courier New, Courier, monospace; font-size: x-small;"><span class="Apple-tab-span" style="white-space: pre;"> </span>return result</span><br /><span style="font-family: Courier New, Courier, monospace; font-size: x-small;">end</span><br /><br />Schlussendlich sieht der Export-Dialog mit ein paar Erweiterung dann so aus:<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://2.bp.blogspot.com/-EfjdPSgqTLo/VUszwrkI5II/AAAAAAAACCk/r2Oe6I1jBAA/s1600/export-dialog.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="371" src="http://2.bp.blogspot.com/-EfjdPSgqTLo/VUszwrkI5II/AAAAAAAACCk/r2Oe6I1jBAA/s640/export-dialog.png" width="640" /></a></div><br /><br /><b>3. Plugin testen</b><br /><br />Für Lua gibt es einige Tools die Unit-Testing bzw. auch BDD-Testing ermöglichen. Am besten gefallen hat mit <a href="http://olivinelabs.com/busted/" target="_blank">busted</a> von Olivine-Labs.<br />Leider ist es etwas aufwändig für das Lightroom SDK ein Test-Harness zu erstellen, deshalb gibt es vorerst noch keine automatischen Tests für mein Plugin.<br />Ich nehme mir vor für die nächste Version das Rendern automatisiert zu testen.<br /><br /><b>4. Installer und Disk-Image erstellen</b><br /><br />Das XCode-Tool <a href="https://developer.apple.com/library/mac/documentation/Darwin/Reference/ManPages/man1/pkgbuild.1.html" target="_blank">pkgbuild</a> ermöglich es, mit der Kommandozeile Pkg-Archive zu erstellen die sich mit dem OSX-Installer installieren lassen.<br /><br /><div class="p1"><span class="s1"><span style="font-family: Courier New, Courier, monospace; font-size: x-small;">pkgbuild --identifier ch.andyhermann.videorenderer --install-location ~/Library/Application\ Support/Adobe/Lightroom/Modules/ --root plugin_src plugin.pkg</span></span></div><br />Leider erscheint ohne signieren des Packages eine Warnung beim Öffnen. Damit muss ich vorerst leben.<br /><br /><table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;"><a href="http://2.bp.blogspot.com/-WfSWKtHzQo8/VUsxu04GhKI/AAAAAAAACCY/HAf8AIjYWHA/s1600/unsigned-package.png" imageanchor="1" style="margin-left: auto; margin-right: auto;"><img border="0" height="182" src="http://2.bp.blogspot.com/-WfSWKtHzQo8/VUsxu04GhKI/AAAAAAAACCY/HAf8AIjYWHA/s320/unsigned-package.png" width="320" /></a></td></tr><tr><td class="tr-caption" style="text-align: center;">Unsigniertes Installer-Package</td></tr></tbody></table><br /><br />Das Verbreiten von Software für Mac OS X wird traditionell mit Disk-Images gemacht.<br />Auch dafür gibt es ein CLI-Tool namens <a href="https://developer.apple.com/library/mac/documentation/Darwin/Reference/ManPages/man1/hdiutil.1.html" target="_blank">hdituil</a> dass sich einfach einbinden lässt:<br /><br /><span style="background-color: white; color: #183691; font-family: Consolas, 'Liberation Mono', Menlo, Courier, monospace; font-size: 12px; line-height: 16.7999992370605px; white-space: pre;">hdiutil create "target/VideoRenderer.dmg</span><span style="background-color: white; color: #183691; font-family: Consolas, 'Liberation Mono', Menlo, Courier, monospace; font-size: 12px; line-height: 16.7999992370605px; white-space: pre;">" -volname "Video Renderer</span><span style="background-color: white; color: #183691; font-family: Consolas, 'Liberation Mono', Menlo, Courier, monospace; font-size: 12px; line-height: 16.7999992370605px; white-space: pre;">" -srcfolder "target/disk_image"</span><br /><br />Natürlich soll der Build alle Schritte automatisiert durchführen. Mangels einfacher Alternativen für lua benutze ich dafür <a href="http://rake.rubyforge.org/" target="_blank">rake</a>.<br /><br /><b>5. Plugin veröffentlichen</b><br /><br />Ich nutze das <a href="https://help.github.com/articles/creating-releases/" target="_blank">Release-Feature</a> von Github für ein einfaches Hosting der Dateien.<br />Die <a href="https://github.com/andreashermann/VideoRenderer/releases/latest" target="_blank">neuste Version</a>&nbsp;des Plugins ist hier verfügbar.<br /><h4>Resultat eines einfachen Timelapse-Videos</h4><br /><div class="separator" style="clear: both; text-align: center;"><iframe allowfullscreen="" frameborder="0" height="315" src="https://www.youtube.com/embed/PnjLQRagY30" width="560"></iframe><br /></div><br /><br />Natürlich fehlen dem Plugin viele wichtige Features wie Deflickering, Stabilization, Ken-Burns etc.<br />Doch die Bedienung ist dafür ziemlich simpel.<br /><br />Ich bin gespannt auf Feedback. Ist das Plugin nützlich für irgend jemanden?<br /><br />Source Code des Projekts:<br /><a href="https://github.com/andreashermann/VideoRenderer">https://github.com/andreashermann/VideoRenderer</a>
