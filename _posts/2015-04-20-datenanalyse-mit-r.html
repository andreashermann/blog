---
layout: post
title: Datenanalyse mit R
---

<div class="p1"><span class="s1">Kürzlich bin ich auf einer News-Website über einen Artikel der Website <a href="http://experimental361.com/"><span class="s2">experimental 361</span></a> gestolpert: <a href="http://experimental361.com/english-premier-league"><span class="s2">English Premier League - Attacking effectiveness, Defense effectiveness</span></a>.</span></div><br /><div class="p1"><span class="s1">Ben Mayhew erklärt anhand von schönen Graphen welche Teams besonders effektiv in der Offensive und Defensive sind. Effektiv bedeutet in diesem Kontext aus wenigen Torchancen ein Tor zu erzielen, bzw. dass der Gegner viele Torchancen benötigt um ein Tor zu schiessen.</span></div><br /><table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;"><a href="http://2.bp.blogspot.com/-P5LHRHnMu0I/VS_KCdkFSYI/AAAAAAAAB_0/mXzPNukHjt0/s1600/experimental-361.png" imageanchor="1" style="margin-left: auto; margin-right: auto;"><img border="0" src="http://2.bp.blogspot.com/-P5LHRHnMu0I/VS_KCdkFSYI/AAAAAAAAB_0/mXzPNukHjt0/s1600/experimental-361.png" height="235" width="320" /></a></td></tr><tr><td class="tr-caption" style="text-align: center;">experimental 3-6-1</td></tr></tbody></table><br /><br /><div class="p1"><span class="s1">Dadurch inspiriert wollte ich eine leicht abgeänderte Frage für die Schweizer Fussballliga beantworten:</span></div><div class="p1"><span class="s1"><b>Welche Stürmer der Super League sind besonders effizient?</b></span><br /><span class="s1"><i>Konkreter: Welcher Stürmer macht die wenigsten Schüsse pro erzieltem Tor?</i><b> </b></span></div><br /><div class="p1"><span class="s1">Die <a href="http://www.r-project.org/"><span class="s2">Programmiersprache R</span></a> eignet sich perfekt um eine solche Aufgabenstellung zu erfüllen.</span></div><br /><div class="p1"><span class="s1">Die Analyse skizziere ich mir etwa so:</span></div><ol class="ol1"><li class="li1"><span class="s1">Laden der Daten</span></li><li class="li1"><span class="s1">Bereinigung und Transformation der Daten</span></li><li class="li1"><span class="s1">Graphische Darstellung</span></li><li class="li1"><span class="s1">Interpretation</span></li></ol><br /><h3><span class="s1">Laden der Daten</span></h3><div><span class="s1">        </span><br /><div class="p1"><span class="s1"><span class="s1">Als Datenquelle nutze ich die öffentlich verfügbaren Statistiken der <a href="http://www.sfl.ch/"><span class="s2">offiziellen Website</span></a> der Swiss Football League. Für jeden Spieler wird schön aufgeschlüsselt wie viele Minuten er gespielt hat, wie viele Tore er schoss und sogar wie viele Schüsse er abgab.</span></span></div><div class="p1"><span class="s1"><span class="s1"> </span></span></div><div class="p1"><span class="s1"><span class="s1"><br /></span></span></div><div class="p1"><span class="s1"><span class="s1">Leider sind die Daten nicht in perfekt strukturierter Form erhältlich, sondern nur eingebettet in der Website. Zum Glück bringt R im <a href="http://cran.r-project.org/web/packages/XML/index.html"><span class="s2">Package XML</span></a> bereits gute Funktionen zum Parsen von HTML mit.</span></span></div><br /><div class="p1"><span class="s1">Zuerst lade ich die Website des Teams:</span><br /><span class="s1"><br /></span> <br /><div class="separator" style="clear: both; text-align: center;"><a href="http://3.bp.blogspot.com/-EMmX5sKENF0/VS_SeplE6kI/AAAAAAAACAY/75LtYiEUjWU/s1600/team.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://3.bp.blogspot.com/-EMmX5sKENF0/VS_SeplE6kI/AAAAAAAACAY/75LtYiEUjWU/s1600/team.png" height="234" width="320" /></a></div><span class="s1"><br /></span><br /><span class="s1">R-Code dazu:<br /></span></div><br /><pre><code class="r"><br />name &lt;- "fc-zuerich"</code></pre><code>url &lt;- paste0("http://www.sfl.ch/superleague/klubs/",name,"/season/201415/")</code></div><div><code>download.file(url, paste0("teams/",name,".html")) </code></div><div><code></code><code class="r"><!-----></code><br /><br /><span class="s1"><span class="s1">Auf der Website des Teams sind alle Spieler aufgelistet und verlinkt. Diesen Links folge ich und lade die Daten ebenfalls von der Website. Das Parsen der Spielerdaten sieht in R dann in etwa so aus:</span></span><br /><pre><code class="r"><br /># alle Tabellen aus dem HTML-Dokument lesen</code></pre><pre><code class="r">library(XML) </code></pre><pre><code class="r">tables &lt;- readHTMLTable(document, stringsAsFactors = FALSE, header = FALSE)</code></pre><code class="r"># Kombination von 2 Tabellen der Seite<br />player.data &lt;- rbind(tables[[1]], tables[[3]])</code></div><div><code class="r"></code></div><div><code class="r"><br /></code><code class="r"><!-----></code>Dann lade und parse ich eine einzelne Spielerseite<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://4.bp.blogspot.com/-dXa3i31-j2I/VS_KCCSltlI/AAAAAAAAB_8/pN02t7fOmaU/s1600/player.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://4.bp.blogspot.com/-dXa3i31-j2I/VS_KCCSltlI/AAAAAAAAB_8/pN02t7fOmaU/s1600/player.png" height="231" width="320" /></a></div><br />R-Code:<br /><pre><code class="r"><br />filename &lt;- paste0("players/", name, ".html")</code></pre><pre><code class="r">download.file(link, filename)&nbsp;</code></pre><pre><code class="r"># Parsen von HTML Tabellen </code></pre><pre><code class="r">tables &lt;- readHTMLTable(filename, stringsAsFactors = FALSE, header = FALSE)</code></pre><pre><code class="r"># Zusammenfassen von mehreren Data Frames </code></pre><pre><code class="r">player.by_row &lt;- rbind(player.by_row, data.frame(V1 = c("name"), V2 = c(name)))</code></pre><pre><code class="r"># Zuweisen der Spaltennamen </code></pre><pre><code class="r">row.names(player.by_row) &lt;- player.by_row$V1</code></pre><pre><code class="r"># Erstellen eines Data Frames </code></pre><pre><code class="r">player &lt;- data.frame(t(select(player.by_row, V2)), stringsAsFactors = F)</code></pre><br /><div class="p1"><span class="s1"><span class="s1">Natürlich lade ich für die ganze Analyse die Daten aller Spieler der zehn Mannschaften der Liga:</span></span></div><ul class="ul1"><li class="li1"><span class="s1"><span class="s1">BSC Young Boys</span></span></li><span class="s1"><li class="li1"><span class="s1">FC Aarau</span></li><li class="li1"><span class="s1">FC Basel 1893</span></li><li class="li1"><span class="s1">FC Luzern</span></li><li class="li1"><span class="s1">FC Sion</span></li><li class="li1"><span class="s1">FC St.&nbsp;Gallen</span></li><li class="li1"><span class="s1">FC Thun</span></li><li class="li1"><span class="s1">FC Vaduz</span></li><li class="li1"><span class="s1">FC Zürich</span></li><li class="li1"><span class="s1">Grasshopper Club</span></li></span></ul><h3><span class="s1">Bereinigung und Transformation</span></h3><div><div class="p1"><span class="s1"><span class="s1">Die Daten der SFL-Website sind konsistent.</span></span></div><div class="p1"><span class="s1"><span class="s1">Dies bedeutet wenig Aufwand um die gewünschten Felder herauszufiltern und die Statistiken zu generieren.</span></span></div><div class="p1"><span class="s1"><span class="s1">Ich beschränke an dieser Stelle die Analyse auf Spieler welche mindestens drei Tore erzielt haben, weil das Diagramm am Schluss sonst zu unübersichtlich wird.</span></span></div><br /><pre><code class="r">library(dplyr)<br />min.goals &lt;- 3</code></pre><pre><code class="r"># filtern, berechnen, sortieren </code></pre><code>player.statistics &lt;- players %&gt;%<br />&nbsp; filter(goals &gt;= min.goals) %&gt;%<br />&nbsp; filter(minutes.played &gt; 0) %&gt;%<br />&nbsp; mutate(shots.per.goal = shots/goals) %&gt;%<br />&nbsp; mutate(minutes.per.shot = minutes.played/shots) %&gt;%<br />&nbsp; mutate(minutes.per.goal = minutes.played/goals) %&gt;%<br />&nbsp; mutate(bmi = weight/(height/100)^2) %&gt;%<br />&nbsp; arrange(shots.per.goal, goals) %&gt;%<br />&nbsp; select(name, goals, shots, minutes.played, team, shots.per.goal, minutes.per.shot, minutes.per.goal)</code><code class="r"><!-----></code><br /><h3><span class="s1"><span class="s2">Graphische Darstellung</span></span></h3></div><div><div class="p1"><span class="s1"><span class="s2"><span class="s1">Mit der Library <a href="http://ggplot2.org/"><span class="s2">ggplot2</span></a> kann man relativ schnell sehr schöne Graphen erstellen. Die Feinjustierung benötigt dann aber doch noch einige Zeit.</span></span></span></div><br /><pre><code class="r"><br />library(ggplot2)<br />library(grid)<br />ggplot(player.statistics, aes(minutes.per.shot, shots.per.goal)) + <br />    ggtitle("Analyse Superleague-Torschützen (&gt;3 Tore)") + <br />    labs(x = "Minuten pro Torschuss", y = "Schüsse pro Tor") +<br />    scale_y_continuous(limits = c(3,11), breaks=seq(2,11,0.5)) + <br />    scale_x_continuous(limits = c(25,75), breaks=seq(0, 90, 5))  +<br />    geom_point(size=4, alpha=1/2, color="steelblue") + <br />    geom_text(aes(label=paste0(name," (",goals,")")),hjust=0, vjust=-0.5) + <br />    geom_hline(yintercept=5.25, linetype="solid", alpha=0.75) +<br />    geom_vline(xintercept=46.3, linetype="solid", alpha=0.75) +<br />    geom_rect(xmin=0, xmax=34.3, ymin=0, ymax=Inf, alpha=0.0025, fill='red') +<br />    geom_rect(xmin=0, xmax=Inf, ymin=0, ymax=4.0, alpha=0.0025, fill='red') +<br />    geom_text(label="Viele Chancen", x=24.25, y=11.1, colour = "red", hjust=0, alpha=0.075) + <br />    geom_text(label="Effizient", x=73.5, y=2.75, colour = "red", hjust=0, alpha=0.075) + <br />    theme(legend.position="none")<br /></code></pre><br /><h3><span class="s1"><span class="s2"><span class="s2">Interpretation</span></span></span></h3><div><span class="s1"><span class="s2"><span class="s2">        </span></span></span><br /><div class="p1"><span class="s1"><span class="s2"><span class="s2"><span class="s1">Dieses Diagram wurde mit dem obigen Code generiert.&nbsp;</span></span></span></span><br /><span class="s1"><span class="s2"><span class="s2"><span class="s1">Die roten Bereiche markieren die Top-25% auf der jeweiligen Achse.</span></span></span></span></div><div class="p1"><span class="s1"><span class="s2"><span class="s2"><span class="s1"><br /></span></span></span></span></div><div class="separator" style="clear: both; text-align: center;"><span class="s1"><span class="s2"><span class="s2"><a href="http://3.bp.blogspot.com/-TY-0DGUk0Vk/VS_LyuNLAVI/AAAAAAAACAI/TD2VcLYpSfU/s1600/result.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://3.bp.blogspot.com/-TY-0DGUk0Vk/VS_LyuNLAVI/AAAAAAAACAI/TD2VcLYpSfU/s1600/result.png" height="228" width="320" /></a></span></span></span></div><div class="p1"><span class="s1"><span class="s2"><span class="s2"><span class="s1"><br /></span></span></span></span></div><div class="p1"><span class="s1"><span class="s2"><span class="s2"><span class="s1"><br /></span></span></span></span></div><div class="p1"><span class="s1"><span class="s2"><span class="s2"><span class="s1">Die Spieler im linken unteren Quadrant sind besonders effizient und benötigen wenige Schüsse um ein Tor zu erzielen. Die Spieler im Quadrant oben rechts benötigen verhältnismässig viele Chancen um ein Tor zu erzielen.</span></span></span></span></div><div class="p1"><span class="s1"><span class="s2"><span class="s2"><br /></span></span></span></div><div class="p1"><span class="s1"><span class="s2"><span class="s2"><span class="s1">        </span></span></span></span></div><div class="p1"><span class="s1"><span class="s2"><span class="s2"><span class="s1">Eine Interpretation hat bereits in einem vorherigen&nbsp;<a href="http://blog.andyhermann.ch/2015/02/superleague-stuermer-statistik.html"><span class="s2">Blogpost</span></a> stattgefunden.</span></span></span></span><br /><br /><span class="s1"><span class="s2"><span class="s2"><span class="s1">Der <a href="https://github.com/andreashermann/football-analysis" target="_blank">ganze Source-Code</a> und die <a href="https://github.com/andreashermann/football-analysis/blob/master/analysis.Rmd" target="_blank">Analyse als R-Markdown-File</a> ist auf Github zu finden. </span></span></span></span></div></div></div></div>
